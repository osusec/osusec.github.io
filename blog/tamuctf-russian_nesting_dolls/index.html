<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65 crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js integrity=sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4 crossorigin=anonymous></script>
<link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Mulish:wght@300;600;800&family=Open+Sans:wght@400;600&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css integrity="sha512-q3eWabyZPc1XTCmF+8/LuE1ozpg5xxn7iO89yfSOd5/oKvyqLngoNGsx8jq92Y8eXJ/IRxQbEC+FGSYxtk2oiw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/solid.min.css integrity="sha512-LopA1sokwAW/FNZdP+/5q8MGyb9CojL1LTz8JMyu/8YZ8XaCDn1EOm6L7RWIIOHRM7K4jwnHuOmyLZeeeYxSOA==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/caseyhates.css><title>TAMUCTF - RUSSIAN_NESTING_DOLLS | OSU Security Club</title></head><body id=background-img style=background-image:url(/blog/tamuctf-russian_nesting_dolls.jpg);background-position:50%><nav class="navbar navbar-expand-lg px-lg-5 py-lg-2 fixed-top topbar bg-light"><div class="container-fluid flex-nowrap px-lg-5"><a class=navbar-brand href=/><img src=/osusec-banner.png class=img-fluid alt=OSUSEC width=450px></a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul><ul class="navbar-nav d-flex mb-2 mb-lg-0"><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/>Home</a></li><li class="nav-item px-1 dropdown"><a class="nav-link text-black dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-expanded=false>About</a><ul class=dropdown-menu><li><a class="dropdown-item topbar topbar-drop shadow-none" href=/about/>Who We Are</a></li><li><a class="dropdown-item topbar topbar-drop shadow-none" href=/club-constitution/>Club Constitution</a></li></ul></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/calendar/>Calendar</a></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/blog/>Blog</a></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/ctf-league/>CTF League</a></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/accomplishments/>Accomplishments</a></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/resources/>Resources</a></li></ul></div></div></nav><main id=main><div id=home-jumbotron class="jumbotron text-center hero-content infopage-hero d-flex flex-column justify-content-center"><h1 class="hero-title py-1">TAMUCTF - RUSSIAN_NESTING_DOLLS</h1></div><div class="bg-light justify-content-center infopage-content" style=min-height:60vh><div class=blog-content><h1 class=blog-title>TAMUCTF - RUSSIAN_NESTING_DOLLS</h1><div class="blog-subtext d-flex flex-wrap"><p class=blog-subtext-item><i class="fa fa-user"></i> Lyell Read</p><p class=blog-subtext-item><i class="fa fa-folder"></i> Tags</p><p class=blog-subtext-item><i class="fa fa-calendar"></i> <time datetime=2020-03-29>Mar 29, 2020</time></p></div><img src=/blog/tamuctf-russian_nesting_dolls.jpg alt="TAMUCTF logo" class=blogcard-img><div class=blog-content-text><h2 id=prompt>Prompt</h2><p>Our monitoring systems noticed some funny-looking DNS traffic on one of our computers. We have the network logs from around the time of the incident. Want to take a look?</p><p>Files: <a href=https://github.com/lyellread/ctf-writeups/blob/master/2020-tamuctf/russian-nesting-dolls/netlogs.pcap>netlogs.pcap</a></p><h2 id=solution>Solution</h2><p>Opening the PCAP up in <code>wireshark</code> shows that there are quite a few (37991) <code>DNS</code> packets, as well as a smattring of others (<code>Statistics > Protocol Hierarchy</code>). Let’s look at the remaining packets first, as there are only a few of them:</p><ul><li>There’s 1 <code>mDNS</code> packet, which appears to have no consequence.</li><li>There are 8 <code>DHCP</code> packets that also appear inconsequential</li><li>There are quite a few <code>FTP</code> packets, from which we can glean a username and password <code>goodag</code> and <code>howdy</code> respectively.</li><li>There are 3 <code>FTP-DATA</code> packets, which include a PGP Public and Private keys, as well as a directory listing (see below).</li></ul><p><a href=https://github.com/lyellread/ctf-writeups/blob/master/2020-tamuctf/russian-nesting-dolls/public-key>PGP Public Key</a> <a href=https://github.com/lyellread/ctf-writeups/blob/master/2020-tamuctf/russian-nesting-dolls/private-key>PGP Private Key</a> Directory Listing:</p><pre tabindex=0><code>drwxr-xr-x    2 1000     1000         4096 Nov 26 21:37 Desktop
drwxr-xr-x    2 1000     1000         4096 Nov 26 21:37 Documents
drwxr-xr-x    2 1000     1000         4096 Nov 26 21:37 Downloads
drwxr-xr-x    2 1000     1000         4096 Nov 26 21:37 Music
drwxr-xr-x    2 1000     1000         4096 Nov 26 21:37 Pictures
drwxr-xr-x    2 1000     1000         4096 Nov 26 21:37 Public
drwxr-xr-x    2 1000     1000         4096 Nov 26 21:37 Templates
drwxr-xr-x    2 1000     1000         4096 Nov 26 21:37 Videos
-rw-r--r--    1 1000     1000         8980 Nov 24 21:15 examples.desktop
-rw-------    1 1000     1000         3589 Nov 27 03:20 priv
-rw-------    1 1000     1000         1698 Nov 27 03:20 pub
</code></pre><p>This directory listing does not look to have much interesting to it, but the PGP keys do.</p><p>Now we turned our attention to the 37991 <code>DNS</code> packets. These each contain a query to a site in the format <code>x6U3gvbExVWkk4U1gzWVU2L2FnRVNYMW5ZTHRjZ0d5b1NiNENYNlFOTVE-tamu1e100net</code>, where the prefix (<code>x6U3gvbExVWkk4U1gzWVU2L2FnRVNYMW5ZTHRjZ0d5b1NiNENYNlFOTVE</code>) looks to be base64 data, and these packets are all in a sequence.</p><p>Let’s look at the first packet: it contains base64 data <code>LS0tLS1CRUdJTiBQR1AgTUVTU0FHRS0tLS0tClZlcnNpb246IEdudVBHI</code> that decodes to</p><pre tabindex=0><code>-----BEGIN PGP MESSAGE-----
Version: GnuPG
</code></pre><p><a href=https://github.com/lyellread/ctf-writeups/blob/master/2020-tamuctf/russian-nesting-dolls/get_pgp_from_dns_b64.py>This script</a> extracts all that data (and ignores repeated packets and mDNS packet) and contactenates it into <a href=https://github.com/lyellread/ctf-writeups/blob/master/2020-tamuctf/russian-nesting-dolls/message.pgp>message.pgp</a>.</p><p>Then, we need to remove the second layer of nested doll, and extract the message:</p><pre tabindex=0><code>$ gpg --import public-key 
gpg: key 18ABAFED3849EB2E: &#34;Ol&#39; Rock &lt;olrock@aggie.network&gt;&#34; not changed
gpg: Total number processed: 1
gpg:              unchanged: 1

$ gpg --import private-key 
gpg: key 18ABAFED3849EB2E: &#34;Ol&#39; Rock &lt;olrock@aggie.network&gt;&#34; not changed
gpg: key 18ABAFED3849EB2E: secret key imported
gpg: Total number processed: 1
gpg:              unchanged: 1
gpg:       secret keys read: 1
gpg:  secret keys unchanged: 1

$ gpg --output out --decrypt message.pgp
gpg: encrypted with 2048-bit RSA key, ID C5372B2EB5E56F58, created 2019-11-27
      &#34;Ol&#39; Rock &lt;olrock@aggie.network&gt;&#34;
</code></pre><p>To decrypt, the password <code>howdy</code> is used when prompted. We get <a href=https://github.com/lyellread/ctf-writeups/blob/master/2020-tamuctf/russian-nesting-dolls/out>out</a>, which <code>file</code> tells us is a <code>gzip</code> archive.</p><pre tabindex=0><code>cp out out.gz
gunzip -c out.gz &gt; ./out-2
</code></pre><p>This creates <a href=https://github.com/lyellread/ctf-writeups/blob/master/2020-tamuctf/russian-nesting-dolls/out-2>out-2</a>, which again is passed to <code>file</code> which tells us it is a <code>tar</code> archive.</p><pre tabindex=0><code>cp out-2 out-2.tar
tar -xvf out-2.tar 
</code></pre><p>This extraction creates a bunch of weird files:</p><pre tabindex=0><code>./..........encoded
./...encoded
./....encoded
./.....encoded
./.......encoded
./......encoded
./...........encoded
./........encoded
./............encoded
./.........encoded
</code></pre><p>Funky! Let’s see what these are. They are each about 156K large (they seem to have 157696 characers each), and all contain data that looks like more base64 data. To make sense of these, we put them into <a href=https://gchq.github.io/CyberChef/>CyberChef</a>, and looked for any indication of what these were. Of all of them, we identified that <a href=https://github.com/lyellread/ctf-writeups/blob/master/2020-tamuctf/russian-nesting-dolls/........encoded>……..encoded</a> starts with <a href=https://www.ntfs.com/jpeg-signature-format.htm>jpeg magic bytes</a>. <a href="https://gchq.github.io/CyberChef/#recipe=From_Base64('A-Za-z0-9%2B/%3D',true)To_Hexdump(16,false,false)&amp;input=YWFhYS85ai80QUFRU2taSlJnQUJBZ0FBWkFCa0FBRC83QUFSUkhWamEza0FBUUFFQUFBQVBBQUEvKzRBSmtGa2IySmxBR1RBQUFBQUFRTUEKRlFRREJnb05BQUE3TUFBQVJJb0FBSHY0QUFEbG52L2JBSVFBQmdRRUJBVUVCZ1VGQmdrR0JRWUpDd2dHQmdnTERBb0tDd29LREJBTQpEQXdNREF3UURBNFBFQThPREJNVEZCUVRFeHdiR3hzY0h4OGZIeDhmSHg4Zkh3RUhCd2NOREEwWUVCQVlHaFVSRlJvZkh4OGZIeDhmCkh4OGZIeDhmSHg4Zkh4OGZIeDhmSHg4Zkh4OGZIeDhmSHg4Zkh4OGZIeDhmSHg4Zkh4OGZIeDhmLzhJQUVRZ0Nsd09OQXdFUkFBSVIKQVFNUkFmL0VBTlVBQVFFQkFRRUJBUUVBQUFBQUFBQUFBQUFCQXdJRUJRWUhBUUVCQVFFQkFRRUFBQUFBQUFBQUFBQUFBUUlEQkFVRwpFQUFCQXdJRkJBTUJBQU1BQXdFQkFBQUJBQkVDRUFNZ01FQWhFbEJnTVFSQkloTXlJeFFGY0RNa1FoVVJBQUVDQXdVRkJnVUNCUVFECkFBQUFBQUVBRVNFeEFoQWdRVkVTUUdGeElnTXdVR0NCa1RLeHdVSlNFNkhSY09GaWdpT0Fjak5Ua3VJa0VnRUFBQUFBQUFBQUFBQUEKQUFBQUFBRFFFd0VBQWdFREF3UUJBd1VCQVFBQUFBQUJBQkVoRURGQklGRmhNRUJ4Z1pHaHNjRlFZUERSNGZGdy85b0FEQU1CQUFJUgpBeEVBQUFINFA2TDg2cEVxd0ZJQVVCUWdGQUFRdFFBQ2doU0FvUUZBUXFBaWdVZ0tnc0VMSTgvRDBaZWYwZFIzR2g2ODNVOG01ejI0CmRlcnpCU0FBc0JSQlFMQUFVZ0FLaUFBQUFxS0lBQUFvZ0lvRlFJVWdBVUNnUUNnQUpRQUNoQlJBVkJGRklFdGdBS1FFQ2lvQkpRRVkKOGUySG05SFMyTjQwVGZPclo1TjU3OXZqdThGRUFLQUVCUUFCQ2dBRUFvQUFBQXNBQUlVRWdvZ3BDa1VVQUNBVUFBQUFxQ2dBQkFDawpvSW9JVUNvSUJGQXFTZ0VvQkpjODc4WGo5blV2Y21zZExzbm96ZlB1YzkrRjlQblVBQVFBb0pTQlFFS0lsVkFBQUJRUUFGQ0toU0JLCkxBUUhTSVVFQlZoU0FvQUVMVUFGSVVBQUZTQUZFQ2tBQUFBQUFBQUlKWkhpOGZ1bWRkeDBuUnBHMGVxWHc5Y1BiNUdvQUJVQUFBQUE">Cyber Chef Link</a>. We convert this to a jpeg using an <a href=https://onlinejpgtools.com/convert-base64-to-jpg>online tool</a>, and get <a href=https://github.com/lyellread/ctf-writeups/blob/master/2020-tamuctf/russian-nesting-dolls/8dot_out.jpg>8dot_out.jpg</a>:</p><p><img src=/blog/tamuctf-russian_nesting_dolls-shark.jpg alt="Photo of a shark"></p><p>That may look like a shark, but it’s actually a nesting doll (what do you know!). I use <a href=https://github.com/zardus/ctf-tools/tree/master/stegsolve>stegsolve</a> to examine the image. In stegsolve, under <code>Analyze > File Format</code> (which you know has something interesting when stegsolve hangs for a second when opening), we can see that, indeed, there’s quite a bit here:</p><pre tabindex=0><code>End of Image 
Additional bytes at end of file = 57524 
Dump of additional bytes: Hex: 
89504e470d0a1a0a
</code></pre><p><code>89 50 4e</code> … That looks like PNG <a href=https://asecuritysite.com/forensics/magic>Magic Bytes</a> :). We need to chop the PNG off the end of this JPG, we do that using <a href=https://github.com/lyellread/ctf-writeups/blob/master/2020-tamuctf/russian-nesting-dolls/extract_png.py>extract_png.py</a>, and we get <a href=https://github.com/lyellread/ctf-writeups/blob/master/2020-tamuctf/russian-nesting-dolls/out.png>out.png</a>.</p><p><img src=/blog/tamuctf-russian_nesting_dolls-flag.png alt="MS Paint drawing with the flag written out"></p><pre tabindex=0><code>gigem{dont_you_just_love_a_good_pcap?}
</code></pre><p>~CaptainGeech, Lyell Read</p></div></div></div></main><footer class="border-top py-4 bg-light"><div class="text-muted text-center"><p>© 2023 OSU Security Club.</p><p>Contact us at: <a href=mailto:security.club@oregonstate.edu class="text-reset text-decoration-none fw-bold">security.club@oregonstate.edu</a></p></div></footer></body></html>