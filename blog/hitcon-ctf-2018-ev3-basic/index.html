<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65 crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js integrity=sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4 crossorigin=anonymous></script>
<link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Mulish:wght@300;600;800&family=Open+Sans:wght@400;600&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css integrity="sha512-q3eWabyZPc1XTCmF+8/LuE1ozpg5xxn7iO89yfSOd5/oKvyqLngoNGsx8jq92Y8eXJ/IRxQbEC+FGSYxtk2oiw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/solid.min.css integrity="sha512-LopA1sokwAW/FNZdP+/5q8MGyb9CojL1LTz8JMyu/8YZ8XaCDn1EOm6L7RWIIOHRM7K4jwnHuOmyLZeeeYxSOA==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/caseyhates.css><title>HITCON CTF 2018 EV3 Basic | OSU Security Club</title></head><body id=background-img style=background-image:url(/blog/hitcon-ctf-2018-ev3-basic.jpg);background-position:50%><nav class="navbar navbar-expand-lg px-lg-5 py-lg-2 fixed-top topbar bg-light"><div class="container-fluid flex-nowrap px-lg-5"><a class=navbar-brand href=/><img src=/osusec-banner.png class=img-fluid alt=OSUSEC width=450px></a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul><ul class="navbar-nav d-flex mb-2 mb-lg-0"><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/>Home</a></li><li class="nav-item px-1 dropdown"><a class="nav-link text-black dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-expanded=false>About</a><ul class=dropdown-menu><li><a class="dropdown-item topbar topbar-drop shadow-none" href=/about/>Who We Are</a></li><li><a class="dropdown-item topbar topbar-drop shadow-none" href=/club-constitution/>Club Constitution</a></li><li><a class="dropdown-item topbar topbar-drop shadow-none" href=/wicys/>WiCyS</a></li></ul></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/calendar/>Calendar</a></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/blog/>Blog</a></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/ctf-league/>CTF League</a></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/accomplishments/>Accomplishments</a></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/resources/>Resources</a></li></ul></div></div></nav><main id=main><div id=home-jumbotron class="jumbotron text-center hero-content infopage-hero d-flex flex-column justify-content-center"><h1 class="hero-title py-1">HITCON CTF 2018 EV3 Basic</h1></div><div class="bg-light justify-content-center infopage-content" style=min-height:60vh><div class=blog-content><h1 class=blog-title>HITCON CTF 2018 EV3 Basic</h1><div class="blog-subtext d-flex flex-wrap"><p class=blog-subtext-item><i class="fa fa-user"></i> Zander Work</p><p class=blog-subtext-item><i class="fa fa-folder"></i> Tags</p><p class=blog-subtext-item><i class="fa fa-calendar"></i> <time datetime=2018-10-22>Oct 22, 2018</time></p></div><img src=/blog/hitcon-ctf-2018-ev3-basic.jpg alt class=blogcard-img><div class=blog-content-text><p><a href=https://github.com/zzzanderw/ctf-writeups/tree/master/hitcon2018/ev3basic>Link to Github</a></p><p><img src=/blog/hitcon-ctf-2018-ctfd.png alt="Screenshot of a CTFd challenge called EV3 Basic with a TAR archive to download."></p><p>Even though this was a pretty simple challenge, I really enjoyed it and wanted to do a write-up for it anyways.</p><p>EV3 is the latest generation of the <a href=https://www.lego.com/en-us/mindstorms>LEGO Mindstorms</a> robots, and thanks to this challenge I know a lot more about the Mindstorms Communication and Firmware Developer Kits than I ever thought I would.</p><p>The challenge includes two files: A picture of the screen of the robot, and a .pklg file, which turned out to be a Bluetooth HCI Log.</p><p><img src=/blog/hitcon-ctf-2018-ev3.jpg alt="Photo of a LEGO Mindstorms EV3, displaying a screen of a challenge flag with most of the characters missing"></p><p>Based on the photo, it was pretty easy to figure out that we needed to get some data out of the Bluetooth log to identify the missing characters.</p><p>After opening the log in Wireshark and doing some display filtering, we can see a conversation between “localhost” (turned out to be a Macbook Pro) and the EV3.</p><p><img src=/blog/hitcon-ctf-2018-wireshark.png alt="Screenshot of many lines of Bluetooth dialog in Wireshark"></p><p>Looking at the data revealed a pretty simple conversation. The MacBook would send a command, and the EV3 would acknowledge it.</p><p><img src=/blog/hitcon-ctf-2018-wireshark1.png alt="Screenshot of Wireguard, showing a command sent from the laptop to the EV3"></p><p><img src=/blog/hitcon-ctf-2018-wireshark2.png alt="Screenshot of Wireguard, showing an acknowledgement sent from the EV3 to the laptop"></p><p>The responses from the EV3 were constant, so I didn’t spend time analyzing those and solely worked on data being sent by the MacBook.</p><p>Thanks to some nice Google searches, I found two developer docs from LEGO: the <a href="https://le-www-live-s.legocdn.com/sc/media/files/ev3-developer-kit/lego%20mindstorms%20ev3%20communication%20developer%20kit-f691e7ad1e0c28a4cfb0835993d76ae3.pdf?la=en-us">Communication Developer Kit</a> and the <a href="https://le-www-live-s.legocdn.com/sc/media/files/ev3-developer-kit/lego%20mindstorms%20ev3%20firmware%20developer%20kit-7be073548547d99f7df59ddfd57c0088.pdf?la=en-us">Firmware Development Kit</a>. These documents made analyzing the data much easier.</p><p>Here is the data for one packet sent by the MacBook:</p><pre tabindex=0><code>12 00 2a 00 00 00 00 84 05 01 81 5a 81 28 84 31 00 84 00 80
                      |  |  |  |  |  |  |  |  |  |
                      |  |  |  |  |  |  |  |  =====&gt; string (1)
                      |  |  |  |  |  |  |  |
                      |  |  |  |  |  |  ===========&gt; y coord
                      |  |  |  |  |  |
                      |  |  |  ====================&gt; x coord
                      |  |  |
                      |  |  =======================&gt; color
                      |  |
                      |  ==========================&gt; command (TEXT)
                      |
                      =============================&gt; opcode (opUI_DRAW)

(the first few bytes are length, sequence number, and local/global variable declaration, and aren&#39;t important for this challenge)
</code></pre><p>This command would write the character “1” at (0x5a, 0x28).</p><p>You’ll notice that there are three bytes for the x coord, and two bytes for the y coord. Turns out, there are some inconsistencies with the documentation and the Bluetooth log for how big the coordinates are supposed to be (or there is other data being put in there that isn’t consistent/documented). The log has packets with data sizes of 19, 20, and 21 bytes (the example above is 20 bytes). Here’s what I figured out for parsing data on the various length packets:</p><ul><li>If there are 19 bytes of data, the x coord is at the 10th byte (starting with 0 on the left), and the y coord is at the 12th byte.</li><li>If there are 20 bytes of data, the x coord is somewhere in the 10th-12th byte, and whichever byte is lower than 0x80 is the correct byte. The y coord is constant at the 13th byte.</li><li>If there are 21 bytes of data, the x coord is at the 11th byte, the y coord is somewhere between the 14th-17th byte, and whichever byte is lower than 0x80 is the correct byte.</li></ul><p>With that information at hand, I wrote a Python script to analyze the data (exported as JSON from Wireshark) and output the flag:</p><pre tabindex=0><code>$ ./solve.py
hitcon{m1nd5t0rm_communication_and_firmware_developer_kit}
</code></pre><p>Here is a <a href=https://github.com/zzzanderw/ctf-writeups/tree/master/hitcon2018/ev3basic>link to my folder on GitHub</a> where I have the files for the challenge and my script to get the flag.</p></div></div></div></main><footer class="border-top py-4 bg-light"><div class="text-muted text-center"><p>© <script>document.write((new Date).getFullYear())</script>OSU Security Club.</p><p>Contact us at:
<a href=mailto:security.clubs@oregonstate.edu class="text-reset text-decoration-none fw-bold">security.clubs@oregonstate.edu</a></p><div class=mt-3><div class="d-flex justify-content-center gap-3"><a href=https://www.instagram.com/dam.secure/ target=_blank class=text-reset title=Instagram><i class="fab fa-instagram" aria-hidden=true></i></a>
<a href=https://x.com/OSUSEC target=_blank class=text-reset title=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></div></div></div></footer></body></html>