<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65 crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js integrity=sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4 crossorigin=anonymous></script>
<link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Mulish:wght@300;600;800&family=Open+Sans:wght@400;600&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css integrity="sha512-q3eWabyZPc1XTCmF+8/LuE1ozpg5xxn7iO89yfSOd5/oKvyqLngoNGsx8jq92Y8eXJ/IRxQbEC+FGSYxtk2oiw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/solid.min.css integrity="sha512-LopA1sokwAW/FNZdP+/5q8MGyb9CojL1LTz8JMyu/8YZ8XaCDn1EOm6L7RWIIOHRM7K4jwnHuOmyLZeeeYxSOA==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/caseyhates.css><title>VolgaCTF - excellent-crackme | OSU Security Club</title></head><body id=background-img style=background-image:url(/blog/volgactf-excellent-crackme.jpg);background-position:50%><nav class="navbar navbar-expand-lg px-lg-5 py-lg-2 fixed-top topbar bg-light"><div class="container-fluid flex-nowrap px-lg-5"><a class=navbar-brand href=/><img src=/osusec-banner.png class=img-fluid alt=OSUSEC width=450px></a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul><ul class="navbar-nav d-flex mb-2 mb-lg-0"><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/>Home</a></li><li class="nav-item px-1 dropdown"><a class="nav-link text-black dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-expanded=false>About</a><ul class=dropdown-menu><li><a class="dropdown-item topbar topbar-drop shadow-none" href=/about/>Who We Are</a></li><li><a class="dropdown-item topbar topbar-drop shadow-none" href=/club-constitution/>Club Constitution</a></li></ul></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/calendar/>Calendar</a></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/blog/>Blog</a></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/ctf-league/>CTF League</a></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/accomplishments/>Accomplishments</a></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/resources/>Resources</a></li></ul></div></div></nav><main id=main><div id=home-jumbotron class="jumbotron text-center hero-content infopage-hero d-flex flex-column justify-content-center"><h1 class="hero-title py-1">VolgaCTF - excellent-crackme</h1></div><div class="bg-light justify-content-center infopage-content" style=min-height:60vh><div class=blog-content><h1 class=blog-title>VolgaCTF - excellent-crackme</h1><div class="blog-subtext d-flex flex-wrap"><p class=blog-subtext-item><i class="fa fa-user"></i> Lyell Read</p><p class=blog-subtext-item><i class="fa fa-folder"></i> Tags</p><p class=blog-subtext-item><i class="fa fa-calendar"></i> <time datetime=2020-03-29>Mar 29, 2020</time></p></div><img src=/blog/volgactf-excellent-crackme.jpg alt="The VolgaCTF logo" class=blogcard-img><div class=blog-content-text><h2 id=prompt>Prompt</h2><p>Excellent Crackme We know one can do pretty much everything in Excel spreadsheets, but this…</p><p><a href=https://github.com/lyellread/ctf-writeups/blob/master/2020-volgactf/excellent-crackme/VolgaCTF_excel_crackme.xlsm>excel_crackme</a></p><h2 id=solution>Solution</h2><p>An excel challenge – that’s a first for us! Let’s crack that file open. We used LibreOffice, as Excel was not installed and Libreoffice was. Upon opening, we are greeted with a message that mentions that macros will not be run for security reasons. we’ll look into that in a sec, thank you, LibreOffice.</p><p>Firstly, let’s look at the spreadsheet:</p><p><img src=/blog/volgactf-excellent-crackme-spreadsheet.jpg alt="Screenshot of the spreadsheet"></p><p>Nice colors. We see an entry box, and what looks like a submit box. The first thing we did was select all cells, and change text color to not yellow, on a hunch that there is hidden text or data somewhere in the sheet. There is, though we did not find it at first.</p><p>Under <code>Tools > Macros > Edit Macros</code>, we can see the following:</p><p><img src=/blog/volgactf-excellent-crackme-macros.jpg alt="Screenshot of the spreadsheet&amp;rsquo;s macros"></p><p>This looks like slightly obfuscated VPA (Visual Basic for Applications). On further inspection, it appears that everything listed under <code>Module1</code> is the same file, just different functions. Therefore, we extract <code>VolgaCTF</code> into <a href=https://github.com/lyellread/ctf-writeups/blob/master/2020-volgactf/excellent-crackme/VolgaCTFRaw.bas>VolgaCTFRaw.bas</a>.</p><p>Then, we began manually deobfuscating it, renaming variables and indenting appropriately. We needed not get further than the first function (fine, subroutine) <code>VolgaCTF()</code> to undstand what is going on. Here is that function (deobfuscated):</p><pre tabindex=0><code>Private Sub VolgaCTF()
	Dim string_1 As String
	Dim long_1 As Long
	Dim long_2 As Long
	Dim long_3 As Long
	string_1 = Range(Chr(76) &amp; Chr(&amp;H31) &amp; Chr(Int(&#34;53&#34;)))
	For idx_outer = 1 To Len(string_1)
		long_1 = 0
		For idx = 1 To Len(string_1)
			long_2 = CInt(Cells(99 + idx_outer, 99 + idx).Value)
			middle = Mid(string_1, idx, 1)
			long_1 = long_1 + long_2 * Asc(middle)
		Next idx
		long_3 = CLng(Cells(99 + idx_outer, 99 + Len(string_1) + 1).Value)
		If (long_3 &lt;&gt; long_1) Then
			MsgBox Func5(Chr(350416 / 2896) &amp; Chr(Int(&#34;114&#34;)) &amp; Chr(Int(&#34;&amp;H72&#34;)) &amp; Chr(Int(&#34;57&#34;)) &amp; Chr(&amp;H56) &amp; Chr(&amp;H75) &amp; &#34;q&#34; &amp; Chr(Int(&#34;113&#34;)) &amp; Chr(4751 - 4652) &amp; Chr(Int(&#34;69&#34;)) &amp; Chr(&amp;H54) &amp; Chr(&amp;H67) &amp; Chr(Int(&#34;&amp;H59&#34;)) &amp; Chr(102) &amp; &#34;V&#34; &amp; Chr(Int(&#34;86&#34;)))
			Exit Sub
		End If
	Next idx_outer

	MsgBox Func5(Chr(Int(&#34;109&#34;)) &amp; &#34;q&#34; &amp; Chr(Int(&#34;49&#34;)) &amp; Chr(Int(&#34;57&#34;)) &amp; Chr(&amp;H56) &amp; Chr(&amp;H65) &amp; Chr(76) &amp; Chr(Int(&#34;112&#34;)) &amp; Chr(Int(&#34;86&#34;)) &amp; &#34;F&#34; &amp; Chr(Int(&#34;114&#34;)) &amp; Chr(-343 + 395) &amp; Chr(&amp;H32) &amp; Chr(72) &amp; Chr(Int(&#34;&amp;H31&#34;)) &amp; Chr(100))
End Sub
</code></pre><p>This can be better understood with <a href=https://github.com/SublimeText/VBScript>VBScript syntax highlighting</a>:</p><p><img src=/blog/volgactf-excellent-crackme-function.png alt="Screenshot of the VolgaCTF() function"></p><p>Firstly, some local variables are defined (<code>long_1</code>, <code>long_2</code>, <code>long_3</code>). Then <code>string_1</code> is set to the <code>Range()</code> of <code>Chr(76) & Chr(&amp;H31) & Chr(Int("53"))</code>. This becomes <code>Range("L" & "1" & "5")</code> (note that <code>&amp;H31 == 0x31</code> and elsewhere, the <code>&</code> operator is concatenation). Therefore, this becomes <code>Range(L15)</code> – this is where the text is entered in the Excel sheet, so <code>string_1</code> is the user input.</p><p>Therefore, the outer loop iterates over the length of user input. We then identified that the first call to <code>MsgBox</code> is the one that issues the failure message, and the final one was the success message. We only fail if <code>long_3 != long_1</code>.</p><p><code>long_1</code> is set by repeating for each character in input string, adding the value of the cell at <code>99 + idx_outer, 99 + idx</code> multiplied by the ascii value of the current character (at <code>idx</code>).</p><p><code>long_3</code> is set by <code>long_3 = CLng(Cells(99 + idx_outer, 99 + Len(string_1) + 1).Value)</code> which takes the value of cell <code>99 + idx_outer, 99 + Len(string_1) + 1</code>. Knowing this, we looked at what data is in the sheet around 100,100:</p><p><img src=/blog/volgactf-excellent-crackme-matrix.png alt="Screenshot of spreadsheet matrix"></p><p>The last column is the ‘vector’ while the rest is the ‘matrix’. The code is essentially taking the dot product of the two. We can undo the operations done, and get the ascii value of the characters of the flag by performing <code>matrix\vector</code> in <code>sage</code>. <a href=https://github.com/lyellread/ctf-writeups/blob/master/2020-volgactf/excellent-crackme/excellent-crackme-solve.sage>Here is the sage script</a>.</p><pre tabindex=0><code>VolgaCTF{7h3_M057_M47h_cr4ckM3_y0u_3V3R_533N}
</code></pre><p>~Lyell Read, Phillip Mestas, Lance Roy</p></div></div></div></main><footer class="border-top py-4 bg-light"><div class="text-muted text-center"><p>© 2023 OSU Security Club.</p><p>Contact us at: <a href=mailto:security.clubs@oregonstate.edu class="text-reset text-decoration-none fw-bold">security.clubs@oregonstate.edu</a></p></div></footer></body></html>