<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65 crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js integrity=sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4 crossorigin=anonymous></script>
<link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Mulish:wght@300;600;800&family=Open+Sans:wght@400;600&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css integrity="sha512-q3eWabyZPc1XTCmF+8/LuE1ozpg5xxn7iO89yfSOd5/oKvyqLngoNGsx8jq92Y8eXJ/IRxQbEC+FGSYxtk2oiw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/solid.min.css integrity="sha512-LopA1sokwAW/FNZdP+/5q8MGyb9CojL1LTz8JMyu/8YZ8XaCDn1EOm6L7RWIIOHRM7K4jwnHuOmyLZeeeYxSOA==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/caseyhates.css><title>UTCTF 2019 - Rogue Leader | OSU Security Club</title></head><body id=background-img style=background-image:url(/blog/utctf-2019-rogue-leader.jpg);background-position:50%><nav class="navbar navbar-expand-lg px-lg-5 py-lg-2 fixed-top topbar bg-light"><div class="container-fluid flex-nowrap px-lg-5"><a class=navbar-brand href=/><img src=/osusec-banner.png class=img-fluid alt=OSUSEC width=450px></a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul><ul class="navbar-nav d-flex mb-2 mb-lg-0"><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/>Home</a></li><li class="nav-item px-1 dropdown"><a class="nav-link text-black dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-expanded=false>About</a><ul class=dropdown-menu><li><a class="dropdown-item topbar topbar-drop shadow-none" href=/about/>Who We Are</a></li><li><a class="dropdown-item topbar topbar-drop shadow-none" href=/club-constitution/>Club Constitution</a></li><li><a class="dropdown-item topbar topbar-drop shadow-none" href=/wicys/>WiCyS</a></li></ul></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/calendar/>Calendar</a></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/blog/>Blog</a></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/ctf-league/>CTF League</a></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/accomplishments/>Accomplishments</a></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/resources/>Resources</a></li></ul></div></div></nav><main id=main><div id=home-jumbotron class="jumbotron text-center hero-content infopage-hero d-flex flex-column justify-content-center"><h1 class="hero-title py-1">UTCTF 2019 - Rogue Leader</h1></div><div class="bg-light justify-content-center infopage-content" style=min-height:60vh><div class=blog-content><h1 class=blog-title>UTCTF 2019 - Rogue Leader</h1><div class="blog-subtext d-flex flex-wrap"><p class=blog-subtext-item><i class="fa fa-user"></i> Andrew Quach</p><p class=blog-subtext-item><i class="fa fa-folder"></i> Tags</p><p class=blog-subtext-item><i class="fa fa-calendar"></i> <time datetime=2019-03-10>Mar 10, 2019</time></p></div><img src=/blog/utctf-2019-rogue-leader.jpg alt class=blogcard-img><div class=blog-content-text><h3 id=problem-description>Problem Description</h3><p>Our once-venerable president has committed the unspeakable crime of dine-and-dashing the pizza during our own club meetings. He’s on the run as we speak, but we’re not sure where he’s headed.</p><p>Luckily, he forgot that we had planted a packet sniffer on his laptop, and we were able to retrieve the following capture when we raided his apartment: <a href=https://storage.googleapis.com/utctf/capture.pcapng>[pcap].</a></p><p>He’s too smart to email his plans to himself, but I’m certain he took them with him somehow. Can you help us figure out which country he’s fleeing to?</p><h3 id=reconnaissance>Reconnaissance</h3><p>Loading the file in Wireshark, we can clearly see that it is a USB packet capture. First thing is first, let’s figure out which devices were connected to the machine.</p><p><img src=/blog/utctf-2019-rogue-leader-wireshark.png alt="Screenshot of Wireshark listing USB traffic"></p><p><img src=/blog/utctf-2019-rogue-leader-flashdrive.png alt="Screenshot of Wireshark identifying a device as a flash drive"></p><p>So, device 2 (with bus id 1) is a flash drive. Other notable devices include a gaming mouse (device 9, bus id 2), a keyboard (device 5, bus id 2), and a tablet (device 4, bus id 2).</p><h3 id=dumping-the-flash-drive>Dumping the Flash Drive</h3><p>Let’s try to find any files that have been transferred in/out of the flash drive. These packets will be rather large and have the URB_BULK in/out flags set. Filtering just by size nets us one of these packets.</p><p><img src=/blog/utctf-2019-rogue-leader-urb-bulk.png alt="Screenshot of Wireshark entry with URB_BULK out flag set"></p><p>We can dump this data (File > Export packet bytes). This file turns out to be GPG encrypted data.</p><pre tabindex=0><code>$ file raw.out
raw.out: GPG symmetrically encrypted data (AES256 cipher)
</code></pre><p>Now that we have the encrypted file, a natural thing to look for is the password. We can try to get this password from the packets storing data about keyboard presses.</p><h3 id=recovering-key-presses>Recovering Key Presses</h3><p>We can filter for packets with information about keyboard presses.</p><p><img src=/blog/utctf-2019-rogue-leader-keyboard-presses.png alt="Screenshot of Wireshark USB packets with keyboard presses"></p><p>The “Leftover Data Capture” looks something like this.</p><pre tabindex=0><code>00000a0000000000
0000000000000000
0000130000000000
</code></pre><p>These 8 bytes include the scan code of the keyboard presses. Keyboard modifiers (ctrl, alt, shift) are stored in the first byte. Other key presses are stored in the third byte to the last byte.</p><pre tabindex=0><code>[MODIFIER] [RESERVED] [KEY PRESS x6]
</code></pre><p>Let’s use tshark to dump out all the keyboard data. Note that we’ll filter out empty data.</p><pre tabindex=0><code>$ tshark -r capture.pcapng -Y &#34;((usb.transfer_type == 0x01) &amp;&amp; !(usb.capdata == 00:00:00:00:00:00:00:00) &amp;&amp; (usb.device_address == 5) &amp;&amp; (usb.urb_type == 67))&#34; -e &#34;usb.capdata&#34; -Tfields &gt; keyboard.data
$ head keyboard.data
00:00:0a:00:00:00:00:00
00:00:13:00:00:00:00:00
00:00:0a:00:00:00:00:00
00:00:0a:2c:00:00:00:00
00:00:2c:00:00:00:00:00
00:00:2d:00:00:00:00:00
00:00:06:00:00:00:00:00
00:00:2c:00:00:00:00:00
00:00:09:00:00:00:00:00
00:00:09:0f:00:00:00:00
</code></pre><p>We can use a python script to decode the key presses. I found a script online that does most of the work for me. I only changed it a little to fit my needs (e.g. adding more scan codes).</p><pre tabindex=0><code># Original Source: https://bitvijays.github.io/LFC-Forensics.html
# More Scan Codes: https://gist.github.com/MightyPork/6da26e382a7ad91b5496ee55fdc73db2

usb_codes = {
        0x04:&#34;aA&#34;, 0x05:&#34;bB&#34;, 0x06:&#34;cC&#34;, 0x07:&#34;dD&#34;, 0x08:&#34;eE&#34;, 0x09:&#34;fF&#34;,
        0x0A:&#34;gG&#34;, 0x0B:&#34;hH&#34;, 0x0C:&#34;iI&#34;, 0x0D:&#34;jJ&#34;, 0x0E:&#34;kK&#34;, 0x0F:&#34;lL&#34;,
        0x10:&#34;mM&#34;, 0x11:&#34;nN&#34;, 0x12:&#34;oO&#34;, 0x13:&#34;pP&#34;, 0x14:&#34;qQ&#34;, 0x15:&#34;rR&#34;,
        0x16:&#34;sS&#34;, 0x17:&#34;tT&#34;, 0x18:&#34;uU&#34;, 0x19:&#34;vV&#34;, 0x1A:&#34;wW&#34;, 0x1B:&#34;xX&#34;,
        0x1C:&#34;yY&#34;, 0x1D:&#34;zZ&#34;, 0x1E:&#34;1!&#34;, 0x1F:&#34;2@&#34;, 0x20:&#34;3#&#34;, 0x21:&#34;4$&#34;,
        0x22:&#34;5%&#34;, 0x23:&#34;6^&#34;, 0x24:&#34;7&amp;&#34;, 0x25:&#34;8*&#34;, 0x26:&#34;9(&#34;, 0x27:&#34;0)&#34;,
        0x2C:&#34;  &#34;, 0x2D:&#34;-_&#34;, 0x2E:&#34;=+&#34;, 0x2F:&#34;[{&#34;, 0x30:&#34;]}&#34;,  0x32:&#34;#~&#34;,
        0x33:&#34;;:&#34;, 0x34:&#34;&#39;\&#34;&#34;,  0x36:&#34;,&lt;&#34;,  0x37:&#34;.&gt;&#34;, 0x38:&#34;/?&#34;, 0x4f:&#34;&gt;&#34;,
        0x50:&#34;&lt;&#34;
        }

lines = [&#39;&#39;]

pos = 0
for x in open(&#34;keyboard.data&#34;,&#34;r&#34;).readlines():
    x = x.split(&#39;:&#39;)
    code = int(x[2], 16)

    if code == 0:
        continue

    # 0x51 -&gt; Keyboard Down
    # 0x28 -&gt; Enter;
    if code == 0x51 or code == 0x28:
        pos += 1

        if pos &gt; len(lines)-1:
            lines.append(&#39;&#39;)
        continue

    # 0x52 -&gt; Keyboard Up;
    if code == 0x52:
        pos -= 1
        continue

    # Shift modifier
    if int(x[0],16) == 2:
        lines[pos] += usb_codes[code][1]
    else:
        lines[pos] += usb_codes[code][0]

for x in lines:
    print(x)
</code></pre><p>The output of this is:</p><pre tabindex=0><code>$ python decode.py
gpgg -c fflaagss.ppng
utNOTflag{try_haardeer}
utNOTflag{try_hardeer}
cp flaggs.png.gpg /media/usserr/USB/
</code></pre><p>Although there are some duplicated letters, we can still see the password is
<strong>utNOTflag{try_harder}</strong>. We can now decrypt the file we found before.</p><pre tabindex=0><code>$ gpg -o flags.png -d raw.out
 &lt;type utNOTflag{try_harder} twice&gt;
$ file flags.png
 flags.png: PNG image data, 112 x 163, 8-bit/color RGBA, non-interlaced
</code></pre><p>And we get flags.png!</p><p><img src=/blog/utctf-2019-rogue-leader-flags.png alt="Picture of United Nations country flags"></p><h3 id=last-steps-before-getting-the-flag>Last Steps Before (getting the flag)</h3><p>Now that we have flags.png, perhaps the flag is hidden with some steganography techniques. After fiddling around with it, we find that another image is hidden in the LSB of flags.png. Using an <a href=https://incoherency.co.uk/image-steganography>online tool</a>, we get the hidden image.</p><p><img src=/blog/utctf-2019-rogue-leader-flags.png alt="Picture of the state of Texas overlaid with the Texan flag and the CTF flag"></p><p><strong>Flag: utflag{t3x45_1s_my_f4v0r1te_c0untry}</strong></p></div></div></div></main><footer class="border-top py-4 bg-light"><div class="text-muted text-center"><p>© <script>document.write((new Date).getFullYear())</script>OSU Security Club.</p><p>Contact us at:
<a href=mailto:security.clubs@oregonstate.edu class="text-reset text-decoration-none fw-bold">security.clubs@oregonstate.edu</a></p><div class=mt-3><div class="d-flex justify-content-center gap-3"><a href=https://www.instagram.com/dam.secure/ target=_blank class=text-reset title=Instagram><i class="fab fa-instagram" aria-hidden=true></i></a>
<a href=https://x.com/OSUSEC target=_blank class=text-reset title=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></div></div></div></footer></body></html>